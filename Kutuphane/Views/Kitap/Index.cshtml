@section Styles{
    <link href="//cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
}


<a id="btnEkle" class="btn btn-primary" >EKLE</a>

<table id="tblKitaplar" class="table table-striped">
</table>

<div class="modal fade" id="modalEkle" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitleId">Yazar Ekleme Formu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="txtKitapAd" class="form-control frmInput" placeholder="Lütfen kitabın adını giriniz" /><br />
                <input type="text" id="txtKitapIsbn" class="form-control frmInput" placeholder="Lütfen kitabın ısbn numarasını giriniz" /><br />
                <select id="ddlYazarlar" multiple="multiple" class="form-select"></select>
                <br /><br />
                <select id="ddlYayinEvi" multiple="multiple" class="form-select"></select>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">İptal</button>
                <a id="btnKaydet" class="btn btn-primary">Kaydet</a>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script src="//cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    

    <script>
            var DataTable;
        
            DataTable=$("#tblKitaplar").DataTable({
                ajax:"/Kitap/GetAll",
               dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'pdf',
                    text: 'Save current page',
                    exportOptions: {
                        modifier: {
                            page: 'current'
                        }
                    }
                }
            ],
                columns: [
                    {data:"id",title:"Kitap ID"},
                    {data:"ad",title:"Kitap Adı"},
                    {data:"isbn",title:"Kitap ISBN"},
                    { data: "yazarlar", title: "Kitap Yazarları",render: function(data,type,row){
                    let yazarlar="";
                    for(var item of data){
                        yazarlar+=item.ad+"<br/>"
                    }
                    return yazarlar;
                    }
                    
                    },                 
                { data: "yayinEvleri", title: "Kitap Yayın Evleri",render:function(data,type,row){
                let yayinEvleri="";
                for(var item of data){
                    yayinEvleri+=item.ad+"<br/>"
                }
                return yayinEvleri;
                } },
                { data: "id", title: "İşlemler" , render: function (data, type, row) {

                    return `<a  onclick="kitapSil(${data})" class="btn btn-danger">Sil</a>
                            <a  onclick="kitapDuzenle()" class="btn btn-info">Düzenle</a>`
                }
                }
                ]
            })

            $("#btnEkle").on("click",function(){
            $("#modalEkle").modal("show");

            $.ajax({
                type: "GET",
                url: "/Yazar/GetAll",
                success: function (res) {
                    for (var item of res.data) {
                        $("#ddlYazarlar").append(new Option(item.ad, item.id));

                    }
                    $('#ddlYazarlar').select2({
                        dropdownParent: $("#modalEkle"),
                        placeholder: 'Yazar Seçiniz',
                        width: "100%"
                    });
                }
            });
            $.ajax({
                type: "GET",
                url: "/YayinEvi/GetAll",
                success: function (res) {
                    for (var item of res.data) {
                        $("#ddlYayinEvi").append(new Option(item.ad, item.id))
                    }
                    $('#ddlYayinEvi').select2({
                        dropdownParent: $("#modalEkle"),
                        placeholder: 'Yayın Evi Seçiniz',
                        width: "100%"
                    });
                }
            })

            $(".frmInput").val('');
            $("#btnKaydet").off().one("click", function () {
                let gonderilecekVeri = {
                    ad: $("#txtKitapAd").val(),
                    isbn: $("#txtKitapIsbn").val()
                }
                let yazarlar = [];
                $("#ddlYazarlar option:selected").each(function () {
                    yazarlar.push($(this).val());
                });
                let yayinEvi = [];
                $("#ddlYayinEvi option:selected").each(function () {
                    yayinEvi.push($(this).val());
                });
                $.ajax({
                    type: "POST",
                    url: "/Kitap/Add",
                    data: {
                        kitap: gonderilecekVeri,
                        yazarlar: yazarlar,
                        yayinEvleri: yayinEvi


                    },
                    success: function () {
                        $("#modalEkle").modal("hide");
                        toastr.success("Kayıt başarıyla eklenmiştir", "BAŞARILI !");
                        DataTable.ajax.reload();
                    }
                });
            });
            })
     
            

        function kitapSil(disaridanGelenId) {

            Swal.fire({
                title: 'Silmek istediğiniz emin misiniz ??',
                showCancelButton: true,
                confirmButtonText: 'Evet',
                cancelButtonText: 'Hayır'

            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {

                    $.ajax({
                        type: 'POST',
                        url: '/Kitap/DeleteAjax',
                        data: {
                            id: disaridanGelenId
                        },
                        success: function (res) {
                            $("#trKitapid-" + disaridanGelenId).remove();

                            toastr.success("Silme işlemi başarılı", "BAŞARILI !")
                            DataTable.ajax.reload();
                        }
                    });



                }
            })






        }


    </script>
   
}